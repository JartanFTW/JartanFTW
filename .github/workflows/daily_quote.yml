name: Update Daily Quote

on:
  schedule:
    - cron: "11 6 * * *" # Daily at 1:11 AM Eastern Time (06:11 UTC)
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}

      - name: Insert random quote
        run: |
          QUOTE=$(jq -r '.[] | @base64' quotes.json | shuf -n 1)
          TEXT=$(echo "$QUOTE" | base64 --decode | jq -r '.text')
          AUTHOR=$(echo "$QUOTE" | base64 --decode | jq -r '.author')

          export TEXT AUTHOR

          # Escape HTML special characters to keep README safe
          TEXT_ESC=$(python3 - << 'PY'
          import html, os
          print(html.escape(os.environ["TEXT"]))
          PY
                    )
          
                    AUTHOR_ESC=$(python3 - << 'PY'
          import html, os
          print(html.escape(os.environ["AUTHOR"]))
          PY
                    )

          # Replace content BETWEEN persistent markers
          perl -0777 -i -pe 's/(<!--QUOTE_TEXT_START-->).*?(<!--QUOTE_TEXT_END-->)/$1'"$TEXT_ESC"'$2/sg' README.md
          perl -0777 -i -pe 's/(<!--QUOTE_AUTHOR_START-->).*?(<!--QUOTE_AUTHOR_END-->)/$1â€” '"$AUTHOR_ESC"'$2/sg' README.md

      - name: Commit README
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update quote of the day" || exit 0
          git push
